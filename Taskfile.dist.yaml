version: '3'

vars:
  ARCH:
    sh: uname -m | sed 's/arm64/aarch64/'
  KERNEL_VERSION: ""
  FIRECRACKER_VERSION: ""

tasks:
  default:
    desc: Show available tasks
    silent: true
    cmds:
      - task --list

  get-kernel:
    desc: Get kernel (download or build) for current architecture
    silent: true
    summary: |
      Get Firecracker-compatible kernel (downloads from GitHub releases or builds from source)

      Options:
        KERNEL_VERSION=6.1        Specific kernel version (default: latest stable)
        ARCH=aarch64              Target architecture (default: auto-detect)
        FORCE_BUILD=true          Force building from source (skip download)
        VERIFICATION_LEVEL=high   Set verification level (default: high)
                                    high     - PGP + SHA256 (strongest)
                                    medium   - SHA256 only (no GPG needed)
                                    disabled - No verification (emergency only)

      Examples:
        task get-kernel                                 # Get latest kernel
        task get-kernel KERNEL_VERSION=6.1              # Get kernel 6.1
        task get-kernel FORCE_BUILD=true                # Force build from source
        task get-kernel KERNEL_VERSION=6.1 ARCH=aarch64 # ARM64 build
        task get-kernel VERIFICATION_LEVEL=medium       # Skip PGP verification
        task get-kernel VERIFICATION_LEVEL=disabled     # Skip all verification
    cmds:
      - |
        OPTS="--arch {{.ARCH}}"
        {{if .KERNEL_VERSION}}OPTS="$OPTS --kernel {{.KERNEL_VERSION}}"{{end}}
        {{if .FORCE_BUILD}}OPTS="$OPTS --force-build"{{end}}
        {{if .VERIFICATION_LEVEL}}OPTS="$OPTS --verification-level {{.VERIFICATION_LEVEL}}"{{end}}
        ./get-kernel.sh $OPTS

  test-kernel:
    desc: Test kernel by booting in Firecracker VM
    silent: true
    summary: |
      Test Firecracker-compatible kernel by booting it in a VM

      Options:
        KERNEL_VERSION=6.1        Kernel version to test (default: latest stable)
        FIRECRACKER_VERSION=v1.10 Firecracker version to use (default: latest)
        FORCE_BUILD=true          Force building kernel from source
        VERIFICATION_LEVEL=high   Set verification level (default: high)
                                    high     - PGP + SHA256 (strongest)
                                    medium   - SHA256 only (no GPG needed)
                                    disabled - No verification (emergency only)

      Examples:
        task test-kernel                                # Test latest kernel
        task test-kernel KERNEL_VERSION=6.1             # Test kernel 6.1
        task test-kernel FORCE_BUILD=true               # Force rebuild and test
        task test-kernel KERNEL_VERSION=6.10 FIRECRACKER_VERSION=v1.10.0
        task test-kernel VERIFICATION_LEVEL=medium      # Skip PGP verification
        task test-kernel VERIFICATION_LEVEL=disabled    # Skip all verification

      Requirements:
        - KVM support (/dev/kvm must be accessible)
        - sudo access (for rootfs creation)
    cmds:
      - |
        OPTS=""
        {{if .KERNEL_VERSION}}OPTS="$OPTS --kernel {{.KERNEL_VERSION}}"{{end}}
        {{if .FIRECRACKER_VERSION}}OPTS="$OPTS --firecracker {{.FIRECRACKER_VERSION}}"{{end}}
        {{if .FORCE_BUILD}}OPTS="$OPTS --force-build"{{end}}
        {{if .VERIFICATION_LEVEL}}OPTS="$OPTS --verification-level {{.VERIFICATION_LEVEL}}"{{end}}
        ./test-kernel.sh $OPTS

  create-rootfs:
    desc: Create test rootfs for Firecracker boot testing
    silent: true
    summary: |
      Create a minimal test rootfs that boots and shuts down cleanly

      Options:
        OUTPUT=custom-rootfs.ext4  Output file path (default: artifacts/test-rootfs.ext4)
        SIZE=50                    Size in MB (default: 50)

      Examples:
        task create-rootfs                         # Create default rootfs
        task create-rootfs OUTPUT=test.ext4        # Custom output path
        task create-rootfs SIZE=100                # Larger rootfs
    cmds:
      - |
        {{if .OUTPUT}}
          ./create-test-rootfs.sh {{.OUTPUT}}
        {{else}}
          ./create-test-rootfs.sh
        {{end}}

  clean:
    desc: Remove all build artifacts, caches, and downloads
    silent: true
    summary: |
      Remove all cached builds and downloaded artifacts

      This will:
        - Remove build/ directory (kernel source and build artifacts)
        - Remove artifacts/ directory (built kernels, checksums, test rootfs)
        - Remove bin/ directory (Firecracker binaries and test scripts)
        - Free up ~10GB+ of disk space

      Next run of get-kernel will download or rebuild from scratch
    cmds:
      - echo "Cleaning all build artifacts and caches..."
      - rm -rf build/ artifacts/ bin/
      - echo "Clean complete! Freed up disk space."

  clean-kernel:
    desc: Remove only kernel artifacts (keep Firecracker and rootfs)
    silent: true
    summary: |
      Remove kernel artifacts but keep Firecracker binaries and test rootfs

      Options:
        VERSION=6.1  Remove specific kernel version only
    cmds:
      - |
        {{if .VERSION}}
          echo "Removing kernel {{.VERSION}} artifacts..."
          rm -f artifacts/vmlinux-{{.VERSION}}-* artifacts/Image-{{.VERSION}}-* artifacts/config-{{.VERSION}}-*
        {{else}}
          echo "Removing all kernel artifacts..."
          rm -f artifacts/vmlinux-* artifacts/Image-* artifacts/config-* artifacts/*.sha256
        {{end}}
      - echo "Kernel artifacts removed."

  clean-firecracker:
    desc: Remove cached Firecracker binaries
    silent: true
    cmds:
      - echo "Removing Firecracker binaries..."
      - rm -rf bin/firecracker-*
      - echo "Firecracker binaries removed."

  clean-rootfs:
    desc: Remove test rootfs (will be recreated on next test)
    silent: true
    cmds:
      - echo "Removing test rootfs..."
      - rm -f artifacts/test-rootfs.ext4 artifacts/*.ext4
      - echo "Test rootfs removed."

  build:
    desc: Force build kernel from source (alias for get-kernel with FORCE_BUILD=true)
    silent: true
    cmds:
      - task: get-kernel
        vars:
          FORCE_BUILD: true
          KERNEL_VERSION: "{{.KERNEL_VERSION}}"
          ARCH: "{{.ARCH}}"
          VERIFICATION_LEVEL: "{{.VERIFICATION_LEVEL}}"

  list-artifacts:
    desc: List all cached artifacts
    silent: true
    cmds:
      - echo "=== Kernel Artifacts ==="
      - ls -lh artifacts/ 2>/dev/null || echo "  (none)"
      - echo ""
      - echo "=== Firecracker Binaries ==="
      - ls -lh bin/ 2>/dev/null || echo "  (none)"
      - echo ""
      - echo "=== Build Directory ==="
      - du -sh build/ 2>/dev/null || echo "  (none)"

  check-kvm:
    desc: Check if KVM is available for Firecracker testing
    silent: true
    cmds:
      - |
        if [ -e /dev/kvm ]; then
          if [ -r /dev/kvm ] && [ -w /dev/kvm ]; then
            echo "✓ KVM is available and accessible"
          else
            echo "✗ KVM exists but not accessible"
            echo "  Run: sudo chmod 666 /dev/kvm"
            exit 1
          fi
        else
          echo "✗ KVM not available (/dev/kvm not found)"
          echo "  Firecracker tests require KVM support"
          exit 1
        fi

  install-deps:
    desc: Install required build dependencies (Ubuntu/Debian)
    silent: true
    summary: |
      Install all required dependencies for building kernels

      This installs:
        - build-essential (gcc, make, etc.)
        - Kernel build tools (bison, flex, bc, etc.)
        - Libraries (libncurses, libssl, libelf)
        - Utilities (wget, xz-utils, jq, curl)
        - GPG (gnupg) for PGP signature verification
        - Cross-compilation tools for aarch64 (optional)
    cmds:
      - |
        echo "Installing build dependencies..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          wget \
          xz-utils \
          jq \
          curl \
          gnupg
      - |
        echo ""
        echo "Install aarch64 cross-compilation tools? [y/N]"
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "✓ aarch64 cross-compilation tools installed"
        else
          echo "Skipped aarch64 tools"
        fi
      - echo ""
      - echo "✓ Dependencies installed successfully"
