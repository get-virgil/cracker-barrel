# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  VENV: .venv
  PIP: "{{.VENV}}/bin/pip"
  SPHINX_BUILD: "{{.VENV}}/bin/sphinx-build"
  SPHINX_AUTOBUILD: "{{.VENV}}/bin/sphinx-autobuild"
  SPHINX_OPTS: '{{.SPHINX_OPTS | default ""}}'

tasks:

  install:
    desc: Install documentation dependencies
    deps: [create-venv]
    cmds:
      - "{{.PIP}} install -r requirements.txt"
    status:
      - test -f {{.SPHINX_BUILD}}
      - test -f {{.SPHINX_AUTOBUILD}}

  landing-install:
    desc: Install landing page dependencies
    dir: landing
    cmds:
      - npm ci
    status:
      - test -d node_modules

  landing-build:
    desc: Build landing page
    deps: [landing-install]
    dir: landing
    cmds:
      - npm run build
    sources:
      - src/**/*
      - public/**/*
      - index.html
      - vite.config.ts
      - package.json
    generates:
      - dist/**/*

  sphinx-build:
    desc: Build Sphinx documentation
    deps: [install]
    cmds:
      - "{{.SPHINX_BUILD}} {{.SPHINX_OPTS}} -b html source docs"

  combine:
    desc: Combine landing page and docs into site directory
    deps: [landing-build, sphinx-build]
    cmds:
      - rm -rf site
      - mkdir -p site
      - cp -r landing/dist/* site/
      - mkdir -p site/docs
      - cp -r docs/* site/docs/

  build:
    desc: Build complete documentation site (landing + docs)
    deps: [combine]

  clean:
    desc: Clean all build directories
    cmds:
      - rm -rf docs/
      - rm -rf landing/dist/
      - rm -rf site/

  linkcheck:
    desc: Check for broken links
    deps: [install]
    cmds:
      - "{{.SPHINX_BUILD}} {{.SPHINX_OPTS}} -b linkcheck source docs/linkcheck"

  serve:
    desc: Build and serve full site with landing page (no auto-reload)
    deps: [build]
    cmds:
      - python -m http.server 8000 --directory site

  serve-dev:
    desc: Serve docs with live auto-reload (bypasses landing page)
    deps: [install]
    cmds:
      - "{{.SPHINX_AUTOBUILD}} source docs --port 8000"

  serve-landing:
    desc: Serve landing page with Vite dev server
    dir: landing
    deps: [landing-install]
    cmds:
      - npm run dev

  ci:
    desc: CI checks for documentation
    cmds:
      - task: build
        vars: { SPHINX_OPTS: -W }
      - task: linkcheck
        vars: { SPHINX_OPTS: -W }

  create-venv:
    desc: Create the Python virtual environment
    internal: true
    cmds:
      - python -m venv .venv
    status:
      - test -f {{.VENV}}/bin/python


