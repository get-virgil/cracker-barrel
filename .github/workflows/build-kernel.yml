name: Build Firecracker-Compatible Kernel

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version to build (e.g., 6.18.8). Leave empty for latest stable.'
        required: false
        type: string

permissions:
  contents: write  # Required for creating releases

jobs:
  check-version:
    name: Check Kernel Version
    runs-on: ubuntu-latest
    outputs:
      kernel_version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.check_release.outputs.should_build }}

    steps:
      - name: Get kernel version
        id: get_version
        run: |
          if [ -n "${{ inputs.kernel_version }}" ]; then
            KERNEL_VERSION="${{ inputs.kernel_version }}"
            echo "Using provided kernel version: ${KERNEL_VERSION}"
          else
            KERNEL_VERSION=$(curl -s https://www.kernel.org/releases.json | jq -r '.latest_stable.version')
            echo "Using latest stable kernel version: ${KERNEL_VERSION}"
          fi
          echo "version=${KERNEL_VERSION}" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          KERNEL_VERSION="${{ steps.get_version.outputs.version }}"
          TAG="v${KERNEL_VERSION}"

          # Check if release exists
          if gh release view "$TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Release $TAG already exists, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG does not exist, proceeding with build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build Kernel (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'

    strategy:
      matrix:
        arch: [x86_64, aarch64]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses-dev \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            bc \
            wget \
            xz-utils \
            jq

          # Install cross-compilation tools for aarch64
          if [ "${{ matrix.arch }}" = "aarch64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi

      - name: Cache kernel source
        uses: actions/cache@v4
        with:
          path: build/linux-*.tar.xz
          key: kernel-source-${{ needs.check-version.outputs.kernel_version }}

      - name: Build kernel
        run: |
          ./build-kernel.sh ${{ matrix.arch }} ${{ needs.check-version.outputs.kernel_version }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.arch }}-${{ needs.check-version.outputs.kernel_version }}
          path: artifacts/*
          retention-days: 7

  test:
    name: Test Kernel (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: [check-version, build]
    if: needs.check-version.outputs.should_build == 'true'

    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            kernel_name: vmlinux
          - arch: aarch64
            runner: ubuntu-24.04-arm
            kernel_name: Image
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download kernel artifact
        uses: actions/download-artifact@v4
        with:
          name: kernel-${{ matrix.arch }}-${{ needs.check-version.outputs.kernel_version }}
          path: kernel-artifacts

      - name: Decompress kernel
        run: |
          cd kernel-artifacts
          xz -d ${{ matrix.kernel_name }}-${{ needs.check-version.outputs.kernel_version }}-${{ matrix.arch }}.xz
          ls -lh

      - name: Hash rootfs creation script
        id: rootfs-script-hash
        run: |
          SCRIPT_HASH=$(sha256sum create-test-rootfs.sh | cut -d' ' -f1 | cut -c1-8)
          echo "hash=${SCRIPT_HASH}" >> $GITHUB_OUTPUT
          echo "Script hash: ${SCRIPT_HASH}"

      - name: Cache test rootfs
        id: cache-rootfs
        uses: actions/cache@v4
        with:
          path: test-rootfs.ext4
          key: test-rootfs-${{ steps.rootfs-script-hash.outputs.hash }}
          restore-keys: |
            test-rootfs-${{ github.ref_name }}
            test-rootfs-

      - name: Install Firecracker
        run: |
          FIRECRACKER_VERSION="v1.14.1"
          echo "Downloading Firecracker ${FIRECRACKER_VERSION} for ${{ matrix.arch }}..."
          curl -L -o firecracker.tgz https://github.com/firecracker-microvm/firecracker/releases/download/${FIRECRACKER_VERSION}/firecracker-${FIRECRACKER_VERSION}-${{ matrix.arch }}.tgz
          tar -xzf firecracker.tgz
          sudo mv release-${FIRECRACKER_VERSION}-${{ matrix.arch }}/firecracker-${FIRECRACKER_VERSION}-${{ matrix.arch }} /usr/local/bin/firecracker
          sudo chmod +x /usr/local/bin/firecracker
          firecracker --version

      - name: Create test rootfs
        if: steps.cache-rootfs.outputs.cache-hit != 'true'
        run: |
          chmod +x create-test-rootfs.sh
          ./create-test-rootfs.sh test-rootfs.ext4

      - name: Test kernel boot
        timeout-minutes: 2
        run: |
          echo "Starting Firecracker VM boot test..."

          # Start Firecracker in background
          rm -f /tmp/firecracker.sock
          firecracker --api-sock /tmp/firecracker.sock &
          FIRECRACKER_PID=$!
          echo "Firecracker PID: $FIRECRACKER_PID"

          # Wait for socket to be ready
          for i in {1..10}; do
            if [ -S /tmp/firecracker.sock ]; then
              echo "API socket ready"
              break
            fi
            sleep 0.5
          done

          # Configure boot source
          echo "Configuring boot source..."
          curl -X PUT --unix-socket /tmp/firecracker.sock \
            http://localhost/boot-source \
            -H "Content-Type: application/json" \
            -d "{
              \"kernel_image_path\": \"$(pwd)/kernel-artifacts/${{ matrix.kernel_name }}-${{ needs.check-version.outputs.kernel_version }}-${{ matrix.arch }}\",
              \"boot_args\": \"console=ttyS0 reboot=k panic=1 pci=off init=/init\"
            }"

          # Configure rootfs drive
          echo "Configuring rootfs drive..."
          curl -X PUT --unix-socket /tmp/firecracker.sock \
            http://localhost/drives/rootfs \
            -H "Content-Type: application/json" \
            -d "{
              \"drive_id\": \"rootfs\",
              \"path_on_host\": \"$(pwd)/test-rootfs.ext4\",
              \"is_root_device\": true,
              \"is_read_only\": false
            }"

          # Configure machine
          echo "Configuring machine..."
          curl -X PUT --unix-socket /tmp/firecracker.sock \
            http://localhost/machine-config \
            -H "Content-Type: application/json" \
            -d '{"vcpu_count": 1, "mem_size_mib": 128}'

          # Start VM
          echo "Starting VM..."
          curl -X PUT --unix-socket /tmp/firecracker.sock \
            http://localhost/actions \
            -H "Content-Type: application/json" \
            -d '{"action_type": "InstanceStart"}'

          echo "Waiting for VM to boot and shutdown (max 60s)..."
          # Wait for VM to boot and shutdown
          for i in {1..60}; do
            if ! kill -0 $FIRECRACKER_PID 2>/dev/null; then
              echo "=========================================="
              echo "SUCCESS: VM booted and shut down cleanly!"
              echo "Kernel ${{ matrix.arch }} boot test PASSED"
              echo "=========================================="
              exit 0
            fi
            sleep 1
          done

          # If we get here, VM didn't shut down in time
          echo "=========================================="
          echo "ERROR: VM did not shut down within timeout"
          echo "Kernel ${{ matrix.arch }} boot test FAILED"
          echo "=========================================="
          kill $FIRECRACKER_PID 2>/dev/null || true
          exit 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-version, test]
    if: needs.check-version.outputs.should_build == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts

          # Move all artifacts to release-artifacts directory
          find all-artifacts -type f -exec mv {} release-artifacts/ \;

          # Generate combined SHA256SUMS file
          cd release-artifacts

          # Combine all individual .sha256 files into SHA256SUMS
          cat *.sha256 > SHA256SUMS
          rm *.sha256

          echo "Release artifacts:"
          ls -lh

      - name: Create release notes
        run: |
          KERNEL_VERSION="${{ needs.check-version.outputs.kernel_version }}"
          cat > release-notes.md << EOF
          # Linux Kernel ${KERNEL_VERSION} - Firecracker Compatible

          ## Overview

          Pre-built Linux kernel ${KERNEL_VERSION} configured for AWS Firecracker microVMs.

          ## Architectures

          - **x86_64**: Intel/AMD 64-bit processors
          - **aarch64**: ARM 64-bit processors (e.g., AWS Graviton)

          ## Artifacts

          - \`vmlinux-${KERNEL_VERSION}-x86_64.xz\` - Compressed kernel for x86_64
          - \`Image-${KERNEL_VERSION}-aarch64.xz\` - Compressed kernel for aarch64
          - \`config-${KERNEL_VERSION}-x86_64\` - Kernel configuration for x86_64
          - \`config-${KERNEL_VERSION}-aarch64\` - Kernel configuration for aarch64
          - \`SHA256SUMS\` - Checksums of decompressed kernels

          ## Usage

          1. Download the appropriate kernel for your architecture
          2. Decompress: \`xz -d vmlinux-${KERNEL_VERSION}-x86_64.xz\`
          3. Verify checksum: \`sha256sum -c SHA256SUMS\`
          4. Use with Firecracker

          ## Kernel Configuration

          Based on Firecracker's official microvm-kernel configurations with essential features:
          - KVM guest support
          - VirtIO drivers (block, network, console, balloon)
          - Minimal footprint for fast boot times
          - Security hardening (SECCOMP, SELinux, Spectre/Meltdown mitigations)

          ## Build Information

          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Upstream Release**: [kernel.org - Linux ${KERNEL_VERSION}](https://kernel.org)
          - **Configuration Source**: [Firecracker Guest Configs](https://github.com/firecracker-microvm/firecracker/tree/main/resources/guest_configs)
          - **Tested**: Both x86_64 and aarch64 kernels verified to boot successfully with Firecracker v1.14.1

          ## Verification

          To verify the integrity of the downloaded kernel:

          \`\`\`bash
          # Download and decompress
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/vmlinux-${KERNEL_VERSION}-x86_64.xz
          xz -d vmlinux-${KERNEL_VERSION}-x86_64.xz

          # Download checksums
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/SHA256SUMS

          # Verify
          sha256sum -c SHA256SUMS --ignore-missing
          \`\`\`

          ---

          Built automatically by [cracker-barrel](https://github.com/${{ github.repository }})
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          KERNEL_VERSION="${{ needs.check-version.outputs.kernel_version }}"
          TAG="v${KERNEL_VERSION}"

          # Create release
          gh release create "$TAG" \
            --title "Linux Kernel ${KERNEL_VERSION} - Firecracker Compatible" \
            --notes-file release-notes.md \
            --repo ${{ github.repository }} \
            release-artifacts/*

          echo "Release $TAG created successfully!"
