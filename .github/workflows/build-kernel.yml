# SPDX-License-Identifier: Apache-2.0
name: Build Firecracker-Compatible Kernel

on:
  # Run every 4 hours to catch new kernel releases quickly
  schedule:
    - cron: '0 */4 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version to build (e.g., 6.18.8). Leave empty for latest stable.'
        required: false
        type: string

permissions:
  contents: write  # Required for creating releases

jobs:
  check-version:
    name: Check Kernel Version
    runs-on: ubuntu-latest
    outputs:
      kernel_version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.decide_build.outputs.should_build }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Task
        uses: go-task/setup-task@v1

      - name: Get kernel version
        id: get_version
        run: |
          if [ -n "${{ inputs.kernel_version }}" ]; then
            KERNEL_VERSION="${{ inputs.kernel_version }}"
            echo "Using provided kernel version: ${KERNEL_VERSION}"
          else
            KERNEL_VERSION=$(curl -s https://www.kernel.org/releases.json | jq -r '.latest_stable.version')
            echo "Using latest stable kernel version: ${KERNEL_VERSION}"
          fi
          echo "version=${KERNEL_VERSION}" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
          KERNEL_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          TAG="v${KERNEL_VERSION}"

          # Check if release exists
          if gh release view "$TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Release $TAG already exists, skipping build"
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG does not exist, checking if we can build"
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if checksums are available
        id: check_checksums
        if: steps.check_release.outputs.release_exists == 'false'
        env:
          KERNEL_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          # Check if checksums are available (call script directly to get exact exit code)
          if ./scripts/kernel/check-checksums-available.sh --kernel "$KERNEL_VERSION"; then
            echo "Checksums are available, can proceed with build"
            echo "checksums_available=true" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 1 ]; then
              # Soft fail - timing issue (kernel exists but checksums not published yet)
              echo "::notice title=Build Skipped::Checksums not yet available for kernel $KERNEL_VERSION. This is normal right after a kernel release. The build will be retried on the next scheduled run."
              echo "checksums_available=false" >> $GITHUB_OUTPUT
            else
              # Hard fail - invalid version or network error
              echo "::error title=Build Failed::Invalid kernel version $KERNEL_VERSION or error checking availability"
              echo "checksums_available=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Decide if we should build
        id: decide_build
        run: |
          if [ "${{ steps.check_release.outputs.release_exists }}" = "true" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          elif [ "${{ steps.check_checksums.outputs.checksums_available }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build Kernel (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'

    strategy:
      matrix:
        arch: [x86_64, aarch64]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Task
        uses: go-task/setup-task@v1

      - name: Install build dependencies
        run: task dev:install-deps

      - name: Install cross-compilation tools
        run: task dev:ensure-cross-tools ARCH=${{ matrix.arch }}

      - name: Cache kernel source
        uses: actions/cache@v4
        with:
          path: build/linux-*.tar.xz
          key: kernel-source-${{ needs.check-version.outputs.kernel_version }}

      - name: Build kernel
        run: task kernel:build KERNEL_VERSION=${{ needs.check-version.outputs.kernel_version }} ARCH=${{ matrix.arch }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.arch }}-${{ needs.check-version.outputs.kernel_version }}
          path: artifacts/*
          retention-days: 7

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-version, build]
    if: needs.check-version.outputs.should_build == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Task
        uses: go-task/setup-task@v1

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Consolidate artifacts
        run: task release:consolidate-artifacts

      - name: Sign release artifacts
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: task signing:sign-artifacts

      - name: Create release notes
        run: |
          KERNEL_VERSION="${{ needs.check-version.outputs.kernel_version }}"
          cat > release-notes.md << EOF
          # Linux Kernel ${KERNEL_VERSION} - Firecracker Compatible

          ## Overview

          Pre-built Linux kernel ${KERNEL_VERSION} configured for AWS Firecracker microVMs.

          ## Architectures

          - **x86_64**: Intel/AMD 64-bit processors
          - **aarch64**: ARM 64-bit processors (e.g., AWS Graviton)

          ## Artifacts

          - \`vmlinux-${KERNEL_VERSION}-x86_64.xz\` - Compressed kernel for x86_64
          - \`Image-${KERNEL_VERSION}-aarch64.xz\` - Compressed kernel for aarch64
          - \`config-${KERNEL_VERSION}-x86_64\` - Kernel configuration for x86_64
          - \`config-${KERNEL_VERSION}-aarch64\` - Kernel configuration for aarch64
          - \`SHA256SUMS\` - Checksums of decompressed kernels
          - \`SHA256SUMS.asc\` - PGP signature of SHA256SUMS
          - \`signing-key.asc\` - Public key used to sign this release

          ## Usage

          1. Download the appropriate kernel for your architecture
          2. Verify PGP signature (see Verification section below)
          3. Verify checksum: \`sha256sum -c SHA256SUMS --ignore-missing\`
          4. Decompress: \`xz -d vmlinux-${KERNEL_VERSION}-x86_64.xz\`
          5. Use with Firecracker

          ## Kernel Configuration

          Based on Firecracker's official microvm-kernel configurations with essential features:
          - KVM guest support
          - VirtIO drivers (block, network, console, balloon)
          - Minimal footprint for fast boot times
          - Security hardening (SECCOMP, SELinux, Spectre/Meltdown mitigations)

          ## Build Information

          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Upstream Release**: [kernel.org - Linux ${KERNEL_VERSION}](https://kernel.org)
          - **Configuration Source**: [Firecracker Guest Configs](https://github.com/firecracker-microvm/firecracker/tree/main/resources/guest_configs)
          - **Tested**: Both x86_64 and aarch64 kernels verified to boot successfully with Firecracker v1.14.1

          ## Verification

          ### PGP Signature Verification (Recommended)

          Verify the PGP signature on SHA256SUMS to ensure kernels haven't been tampered with.

          **Note:** Each release includes the exact public key that signed it. This ensures old releases remain verifiable even after key rotation.

          \`\`\`bash
          # Download and import the public key from this release
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/signing-key.asc
          gpg --import signing-key.asc

          # Download checksums and signature
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/SHA256SUMS
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/SHA256SUMS.asc

          # Verify PGP signature
          gpg --verify SHA256SUMS.asc SHA256SUMS

          # If signature is good, verify kernel checksums
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/vmlinux-${KERNEL_VERSION}-x86_64.xz
          xz -d vmlinux-${KERNEL_VERSION}-x86_64.xz
          sha256sum -c SHA256SUMS --ignore-missing
          \`\`\`

          ### Quick Verification (Checksums Only)

          If you trust GitHub's infrastructure and don't need PGP verification:

          \`\`\`bash
          # Download kernel and checksums
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/vmlinux-${KERNEL_VERSION}-x86_64.xz
          wget https://github.com/${{ github.repository }}/releases/download/v${KERNEL_VERSION}/SHA256SUMS

          # Decompress and verify
          xz -d vmlinux-${KERNEL_VERSION}-x86_64.xz
          sha256sum -c SHA256SUMS --ignore-missing
          \`\`\`

          See the [main README](https://github.com/${{ github.repository }}#verifying-releases) for complete verification instructions including key fingerprint.

          ---

          Built automatically by [cracker-barrel](https://github.com/${{ github.repository }})
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          KERNEL_VERSION="${{ needs.check-version.outputs.kernel_version }}"
          TAG="v${KERNEL_VERSION}"

          # Create release
          gh release create "$TAG" \
            --title "Linux Kernel ${KERNEL_VERSION} - Firecracker Compatible" \
            --notes-file release-notes.md \
            --repo ${{ github.repository }} \
            release-artifacts/*

          echo "Release $TAG created successfully!"
